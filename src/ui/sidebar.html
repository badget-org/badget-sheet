<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
  />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body {
      font-family: 'Roboto';
      height: -webkit-fill-available;
    }
  </style>
</head>
<body class="p-4 flex flex-col gap-6 text-slate-900">
  <header>
    <h1 class="font-bold text-2xl">Badget<span class="text-purple-500">.</span></h1>
  </header>

  <section class="flex flex-col gap-3">
    <button class="group flex items-center gap-2 transition" data-accordion>
      <span class="material-symbols-outlined">
        reset_wrench
      </span>
      <span class="font-medium flex-grow text-left">Setup</span>
      <span class="material-symbols-outlined text-slate-400 transition opacity-0 group-hover:opacity-100">
        expand_more
      </span>
    </button>
    <div class="overflow-hidden transition-all max-h-0">
      <div class="py-4 flex flex-col gap-6">
        <p>Go to <a href="https://ob.nordigen.com/" class="text-blue-500 hover:underline">Nordigens's Open Banking Portal</a> and get your own unique User Secrets to use Nordigen's service for accessing banking data and paste the input token in the box bellow.</p>
        <form class="flex flex-col gap-4" onsubmit="setupFormSubmit(this)">
          <div>
              <label for="secret_id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Secret ID *</label>
              <input
                type="text"
                id="secret_id"
                name="secret_id"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                placeholder="secret_id"
                required>
          </div>
          <div>
              <label for="secret_key" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Secret KEY *</label>
              <input
                type="text"
                id="secret_key"
                name="secret_key"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                placeholder="secret_key"
                required
              >
          </div>
          <div class="flex self-end gap-4">
            <button class="text-slate-500 border-slate-300 border bg-white hover:bg-green-50 hover:border-green-200 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-5 py-1 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
              <span class="h-[18px]">Reset sheet</span>
            </button>
            <button type="submit" class="flex items-center gap-2 text-[#137333] border-slate-300 border bg-white hover:bg-green-50 hover:border-green-200 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-4 py-1 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
              <span class="material-symbols-outlined text-lg">
                save
              </span>
              <span class="h-[18px]">Save</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <button class="group flex items-center gap-2 transition" data-accordion>
      <span class="material-symbols-outlined">
        link
      </span>
      <span class="font-medium flex-grow text-left">Connect Account</span>
      <span class="material-symbols-outlined text-slate-400 transition opacity-0 group-hover:opacity-100">
        expand_more
      </span>
    </button>
    <div class="overflow-hidden transition-all max-h-0">
      <div class="py-4 flex flex-col gap-6">
        <p>
          Select your country to list the banks that we can connect to.<br />
          First time you will attempt to list banks you will be required to give permission to Google Apps Scripts to connect to Nordigen's APIs.<br />
        </p>
        <form class="flex flex-col gap-4" onsubmit="connectFormSubmit(this)">
          <div>
              <label for="country_code" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Country</label>
              <select id="country_code" name="country_code" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                <option selected>Choose a country</option>
                <option value="AT">Austria</option>
                <option value="Belgium">Belgium</option>
                <option value="Bulgaria">Bulgaria</option>
                <option value="Croatia">Croatia</option>
                <option value="Cyprus">Cyprus</option>
                <option value="Czechia">Czechia</option>
                <option value="Denmark">Denmark</option>
                <option value="Estonia">Estonia</option>
                <option value="Finland">Finland</option>
                <option value="FR">France</option>
                <option value="Germany">Germany</option>
                <option value="Greece">Greece</option>
                <option value="Hungary">Hungary</option>
                <option value="Iceland">Iceland</option>
                <option value="Ireland">Ireland</option>
                <option value="IT">Italy</option>
                <option value="Latvia">Latvia</option>
                <option value="Liechtenstein">Liechtenstein</option>
                <option value="Lithuania">Lithuania</option>
                <option value="Luxembourg">Luxembourg</option>
                <option value="Malta">Malta</option>
                <option value="Netherlands">Netherlands</option>
                <option value="Norway">Norway</option>
                <option value="Poland">Poland</option>
                <option value="Portugal">Portugal</option>
                <option value="Romania">Romania</option>
                <option value="Slovakia">Slovakia</option>
                <option value="Slovenia">Slovenia</option>
                <option value="Spain">Spain</option>
                <option value="Sweden">Sweden</option>
                <option value="UnitedKingdom">United Kingdom</option>
              </select>
          </div>
          <div>
            <label for="institution_id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Institution</label>
            <select id="institution_id" name="institution_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
              <option selected>Choose an institution</option>
            </select>
          </div>
          <button type="submit" class="self-end text-[#137333] border-slate-300 border bg-white hover:bg-green-50 hover:border-green-200 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Create link</button>
        </form>
      </div>
    </div>
    <button class="group flex items-center gap-2 transition" data-accordion>
      <span class="material-symbols-outlined">
        account_balance_wallet
      </span>
      <span class="font-medium flex-grow text-left">Manage Accounts</span>
      <span class="material-symbols-outlined text-slate-400 transition opacity-0 group-hover:opacity-100">
        expand_more
      </span>
    </button>
    <div class="overflow-hidden transition-all max-h-0">
      <ul class="max-w-md divide-y divide-gray-200 dark:divide-gray-700 py-4">
        <li class="pb-3 sm:pb-4">
           <div class="flex items-center space-x-4">
              <div class="flex-shrink-0">
                <img class="w-8 h-8" src="https://play-lh.googleusercontent.com/2FJCBaELC3xKVd4HiMIOuT2finz1d6ZU7HnhZZdqiCkAH0Zk6I2ZDHzazQ7CVMXxGg=w240-h480-rw" alt="Neil image">
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate dark:text-white">
                  N26 Bank
                </p>
                <p class="text-sm text-gray-500 truncate dark:text-gray-400">
                  2 Accounts
                </p>
              </div>
              <div class="inline-flex gap-4 items-center text-base text-slate-600 dark:text-white">
                 <span class="text-xs">64 days left</span>
                 <button class="self-end text-[#137333] bg-white hover:bg-green-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Renew</button>
              </div>
           </div>
        </li>
        <li class="py-3 sm:py-4">
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              <img class="w-8 h-8" src="https://www.logo.wine/a/logo/Revolut/Revolut-Icon-Logo.wine.svg" alt="Neil image">
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate dark:text-white">
                Revolut
              </p>
              <p class="text-sm text-gray-500 truncate dark:text-gray-400">
                10 Accounts
              </p>
            </div>
            <div class="inline-flex gap-4 items-center text-base text-slate-600 dark:text-white">
               <span class="text-xs">3 days left</span>
               <button class="self-end text-[#137333] bg-white hover:bg-green-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Renew</button>
            </div>
          </div>
        </li>
        <li class="py-3 sm:py-4">
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              <img class="w-8 h-8" src="https://companieslogo.com/img/orig/ISP.MI-e8dc3cc4.png?t=1593230015" alt="Neil image">
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate dark:text-white">
                Intesa Sanpaolo
              </p>
              <p class="text-sm text-gray-500 truncate dark:text-gray-400">
                1 Account
              </p>
            </div>
            <div class="inline-flex gap-4 items-center text-base text-slate-600 dark:text-white">
               <span class="text-xs">130 days left</span>
               <button class="self-end text-[#137333] bg-white hover:bg-green-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-md text-sm sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Renew</button>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <button class="group flex items-center gap-2 transition" data-accordion>
      <span class="material-symbols-outlined">
        savings
      </span>
      <span class="font-medium flex-grow text-left">Manage Budgets</span>
      <span class="material-symbols-outlined text-slate-400 transition opacity-0 group-hover:opacity-100">
        expand_more
      </span>
    </button>
    <div class="overflow-hidden transition-all max-h-0">
      Budgets
    </div>
    <button class="group flex items-center gap-2 transition" data-accordion>
      <span class="material-symbols-outlined">
        settings
      </span>
      <span class="font-medium flex-grow text-left">Settings</span>
      <span class="material-symbols-outlined text-slate-400 transition opacity-0 group-hover:opacity-100">
        expand_more
      </span>
    </button>
    <div class="overflow-hidden transition-all max-h-0">
      Settings
    </div>
  </section>

  <span class="flex-1"></span>
  <footer class="text-slate-600 text-sm">
    Built by <a href="https://badget.io" class="text-slate-600 font-semibold underline">Badget<span class="text-purple-500">.</span></a> Follow us on <a href="https://twitter.com" class="text-slate-600 font-semibold underline">X</a>. 
  </footer>

  <div id="output"></div>

  <!-- Setup -->
  <script>
    // global error management
    function onFailure(error) {
      const div = document.getElementById('output');
      div.innerHTML = "ERROR: " + error.message;
    }

    // global success management
    function onSuccess(message) {
      const div = document.getElementById('output');
      div.innerHTML = "SUCCESS: " + message;
    }

    // prevent forms from submitting.
    function preventFormSubmit() {
      const forms = document.querySelectorAll('form');
      for (let i = 0; i < forms.length; i++) {
        forms[i].addEventListener('submit', function(event) {
          event.preventDefault();
        });
      }
    }

    // accordion
    function initAccordion() {
      const acc = document.querySelectorAll("button[data-accordion]");
      for (let i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          /* Toggle between adding and removing the "active" class,
          to highlight the button that controls the panel */
          this.classList.toggle("active");
          this.querySelector(".text-slate-400").classList.toggle("rotate-180")

          /* Toggle between hiding and showing the active panel */
          var panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
          } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
          }
        });
      }
    }

    // Setup
    function onSecretsRetrieved(secrets) {
      console.log(secrets)
      const secretIdInput = document.getElementById('secret_id');
      const secretKeyInput = document.getElementById('secret_key');
      secretIdInput.value = secrets.secret_id;
      secretKeyInput.value = secrets.secret_key;
    }

    function setupFormSubmit(formObject) {
      google.script.run
        .withFailureHandler(onFailure)
        .withSuccessHandler(onSuccess)
        .setupFormSubmit(formObject);
    }

    // Connect Account
    function getInstitutionsOnCountryChange() {
      const countrySelect = document.getElementById("country_code");
      const institutionSelect = document.getElementById("institution_id");
      countrySelect.addEventListener("change", (e) => {
        const countryCode = e.target.selectedOptions[0].value;
        institutionSelect.innerHTML = "<option selected>Choose an institution</option>";

        function onFindInstitutionsByCountry(institutions) {
          institutions.forEach(institution => {
            const option = document.createElement("option");
            option.value = institution.id;
            option.textContent = institution.name;
            institutionSelect.appendChild(option);
          })
        }

        google.script.run
          .withFailureHandler(onFailure)
          .withSuccessHandler(onFindInstitutionsByCountry)
          .findInstitutionsByCountry(countryCode);
      })
    }

    function connectFormSubmit(formObject) {
      console.log(formObject)
      google.script.run
        .withFailureHandler(onFailure)
        .withSuccessHandler(onSuccess)
        .createRequisition(formObject.institution_id);
    }

    function onLoad() {
      initAccordion();
      preventFormSubmit();
      getInstitutionsOnCountryChange();

      google.script.run
        .withFailureHandler(onFailure)
        .withSuccessHandler(onSecretsRetrieved)
        .getNordigenSecrets();
    }

    window.addEventListener('load', onLoad);
  </script>
</body>
</html>
